<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel da Ger√™ncia</title>

<style>
body{
  font-family:Arial, sans-serif;
  background:#f4f6f8;
  padding:20px;
}
.card{
  max-width:1400px;
  margin:auto;
  background:#fff;
  padding:24px;
  border-radius:8px;
}
h2{
  border-left:5px solid #0077ff;
  padding-left:10px;
  margin-top:0;
}
.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  margin-top:12px;
}
button,a.btn{
  padding:10px 18px;
  border:none;
  border-radius:5px;
  cursor:pointer;
  font-size:14px;
  text-decoration:none;
}
.btn-primary{background:#0077ff;color:#fff;}
.btn-green{background:#28a745;color:#fff;}
.btn-gray{background:#e0e0e0;color:#111;}

#filters{
  display:flex;
  gap:10px;
  margin-top:12px;
  align-items:center;
}

#filters select,
#filters input{
  padding:8px;
  font-size:14px;
}

#statusUser{
  margin-top:10px;
  font-size:13px;
  color:#333;
}

#tabelaWrapUser{
  margin-top:12px;
  overflow:auto;
  max-height:70vh;
  border:1px solid #e6e6e6;
  border-radius:6px;
}

table{
  border-collapse:collapse;
  width:100%;
}

th,td{
  border:1px solid #ddd;
  padding:8px;
  font-size:13px;
  white-space:nowrap;
}

th{
  background:#f0f7ff;
  position:sticky;
  top:0;
  z-index:10;
}

/* Destaque para n√∫meros n√£o-zero */
.valor-destaque{
  font-weight:bold;
  font-size:15px;
}
</style>
</head>

<body>
<div class="card">
  <h2>Painel da Ger√™ncia</h2>

  <div class="row">
    <button id="btnRecarregar" class="btn-green">Recarregar dados</button>
    <a href="index-1.html" class="btn btn-gray">Voltar ao formul√°rio</a>
  </div>

  <!-- FILTROS -->
  <div id="filters">
    <label>Filtrar por:</label>
    <select id="campoFiltro">
      <option value="">Todos</option>
      <option value="Mes_Competencia">M√™s</option>
      <option value="Ano_Competencia">Ano</option>
      <option value="Matricula">Matr√≠cula</option>
      <option value="Email">E-mail</option>
      <option value="Setor_Nucleo">Setor</option>
    </select>

    <input id="filtroValor" placeholder="Digite para filtrar...">
    
    <button id="btnLimparFiltro" class="btn-gray">Limpar</button>
  </div>

  <div id="statusUser"></div>
  <div id="tabelaWrapUser"></div>
</div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwhWlvzkIy_VvF0-oU-p_VI4NTB_prCQNAgYFAfRktzEMKTY5LQhd9niw5z-1nkSuLd5A/exec";
const SENHA = "123";
const LIMIT = 50;

// üîê Verifica√ß√£o de senha
const SENHA_CORRETA = "123";
const senhaDigitada = prompt("Digite a senha da ger√™ncia:");

if (senhaDigitada !== SENHA_CORRETA) {
  document.body.innerHTML = "<div class='card'><h2 style='color:#d32f2f'>‚ùå Acesso negado</h2><p>Senha incorreta.</p></div>";
  throw new Error("Acesso bloqueado");
}

let HEAD = [];
let DATA = [];
let DATA_ORIGINAL = [];

/* ========== JSONP ========== */
function jsonp(url){
  return new Promise((res,rej)=>{
    const cb="cb"+Date.now()+Math.random().toString(36).slice(2);
    window[cb]=d=>{
      delete window[cb];
      s.remove();
      res(d);
    }
    const s=document.createElement("script");
    s.src=url+(url.includes("?")?"&":"?")+"callback="+cb;
    s.onerror=()=>rej("Erro JSONP");
    document.body.appendChild(s);
  });
}

/* ========== SUBSTITUIR 0 POR "-" ========== */
function formatarValor(valor){
  if(valor === 0 || valor === "0") return "-";
  return valor ?? "";
}

/* ========== DESTACAR N√öMEROS N√ÉO-ZERO ========== */
function aplicarDestaque(){
  const cells = document.querySelectorAll('tbody td');
  
  cells.forEach(cell => {
    const valor = cell.textContent.trim();
    const numero = parseFloat(valor);
    
    // Se for n√∫mero e diferente de 0
    if (!isNaN(numero) && numero !== 0) {
      cell.classList.add('valor-destaque');
    }
  });
}

/* ========== RENDER TABELA ========== */
function renderTabela(data){
  if(!data || data.length < 2){
    tabelaWrapUser.innerHTML = "<p>Nenhum dado dispon√≠vel</p>";
    return;
  }

  tabelaWrapUser.innerHTML = `
    <table>
      <thead>
        <tr>${data[0].map(h=>`<th>${h}</th>`).join("")}</tr>
      </thead>
      <tbody>
        ${data.slice(1).map(r=>`
          <tr>${r.map(c=>`<td>${formatarValor(c)}</td>`).join("")}</tr>
        `).join("")}
      </tbody>
    </table>
  `;
  
  // Aplicar destaque ap√≥s renderizar
  aplicarDestaque();
}

/* ========== FILTRO POR COLUNA ========== */
function aplicarFiltro(){
  const campo = campoFiltro.value;
  const termo = filtroValor.value.trim().toLowerCase();

  if(!campo || !termo){
    renderTabela(DATA_ORIGINAL);
    statusUser.textContent=`Registros carregados: ${DATA_ORIGINAL.length - 1}`;
    return;
  }

  const rowIndex = DATA_ORIGINAL.findIndex(r => r[0] === campo);
  
  if(rowIndex === -1){
    statusUser.textContent="Campo n√£o encontrado";
    return;
  }

  const colunasValidas = [];

  for(let c=1; c<DATA_ORIGINAL[rowIndex].length; c++){
    const valor = String(DATA_ORIGINAL[rowIndex][c] ?? "").toLowerCase();
    if(valor.includes(termo)) colunasValidas.push(c);
  }

  if(colunasValidas.length === 0){
    statusUser.textContent="‚ùå Nenhum registro encontrado";
    tabelaWrapUser.innerHTML="<p style='padding:20px;text-align:center'>Nenhum resultado para este filtro</p>";
    return;
  }

  const filtrado = DATA_ORIGINAL.map(r=>[
    r[0],
    ...colunasValidas.map(c=>r[c])
  ]);

  renderTabela(filtrado);
  statusUser.textContent = `‚úÖ Registros encontrados: ${colunasValidas.length}`;
}

/* ========== LIMPAR FILTRO ========== */
function limparFiltro(){
  campoFiltro.value = "";
  filtroValor.value = "";
  renderTabela(DATA_ORIGINAL);
  statusUser.textContent=`Registros carregados: ${DATA_ORIGINAL.length - 1}`;
}

/* ========== CARREGAR DADOS ========== */
async function carregarTabela(){
  statusUser.textContent = "‚è≥ Carregando...";
  tabelaWrapUser.innerHTML = "";
  DATA_ORIGINAL = [];

  try {
    console.log("üìä Carregando p√°gina 1...");
    const first = await jsonp(`${WEBAPP_URL}?senha=${SENHA}&page=1&limit=${LIMIT}`);

    if (!first || !first.ok) {
      statusUser.textContent = "‚ùå " + (first?.erro || "Erro ao carregar dados");
      statusUser.style.color = "#d32f2f";
      return;
    }

    HEAD = first.head;
    DATA_ORIGINAL = [HEAD, ...first.rows];
    
    console.log(`‚úÖ P√°gina 1: ${first.rows.length} registros`);

    for (let p = 2; p <= first.totalPages; p++) {
      console.log(`üìä Carregando p√°gina ${p}...`);
      const d = await jsonp(`${WEBAPP_URL}?senha=${SENHA}&page=${p}&limit=${LIMIT}`);

      if (!d || !d.ok) {
        statusUser.textContent = "‚ùå " + (d?.erro || "Erro ao carregar p√°ginas");
        statusUser.style.color = "#d32f2f";
        return;
      }

      DATA_ORIGINAL.push(...d.rows);
    }

    renderTabela(DATA_ORIGINAL);
    statusUser.textContent = `‚úÖ Registros carregados: ${DATA_ORIGINAL.length - 1}`;
    statusUser.style.color = "#333";
    
    console.log(`‚úÖ Total de registros: ${DATA_ORIGINAL.length - 1}`);

  } catch (err) {
    statusUser.textContent = "‚ùå Erro inesperado: " + err;
    statusUser.style.color = "#d32f2f";
    console.error(err);
  }
}

/* ========== EVENTOS ========== */
btnRecarregar.onclick = carregarTabela;
btnLimparFiltro.onclick = limparFiltro;

let timer;
filtroValor.addEventListener("input",()=>{
  clearTimeout(timer);
  timer=setTimeout(aplicarFiltro,300);
});

campoFiltro.addEventListener("change", ()=>{
  if(filtroValor.value.trim()){
    aplicarFiltro();
  }
});

// Enter para filtrar
filtroValor.addEventListener("keypress", (e)=>{
  if(e.key === "Enter"){
    aplicarFiltro();
  }
});

// Carregar ao iniciar
carregarTabela();
</script>
</body>
</html>
