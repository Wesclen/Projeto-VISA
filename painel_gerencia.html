<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Painel Gerência</title>

<style>
  body{font-family:Arial,sans-serif;background:#f4f6f8;padding:20px;}
  .card{max-width:1100px;margin:0 auto;background:#fff;padding:24px;border-radius:8px;}
  h2{border-left:5px solid #0077ff;padding-left:10px;margin-top:0;}

  label{font-weight:bold;display:block;margin-top:12px;}
  input{width:100%;max-width:360px;padding:10px;margin-top:6px;box-sizing:border-box;}

  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px;}
  button,a.btn{padding:10px 18px;border:none;border-radius:5px;cursor:pointer;text-decoration:none;display:inline-block;font-size:14px;}
  .btn-primary{background:#0077ff;color:#fff;}
  .btn-primary:hover{background:#0056cc;}
  .btn-green{background:#28a745;color:#fff;}
  .btn-green:hover{background:#1f7e34;}
  .btn-gray{background:#e0e0e0;color:#111;}
  .btn-gray:hover{background:#d1d1d1;}
  button:disabled{opacity:.6;cursor:not-allowed;}

  .msg{margin-top:10px;color:#b00020;font-size:13px;}
  #statusUser{margin-top:10px;color:#333;font-size:13px;}

  #tabelaWrapUser{margin-top:12px;overflow:auto;max-height:70vh;background:#fff;border:1px solid #e6e6e6;border-radius:6px;}
  #tabelaWrapUser table{border-collapse:collapse;width:100%;}
  #tabelaWrapUser th,#tabelaWrapUser td{border:1px solid #ddd;padding:8px;font-size:13px;}
  #tabelaWrapUser th{background:#f0f7ff;position:sticky;top:0;}
</style>
</head>

<body>
  <div class="card">
    <h2>Painel da Gerência</h2>

    <!-- LOGIN -->
    <div id="loginBox">
      <p>Para acessar, digite a senha da gerência.</p>

      <label for="senhaPainel">Senha</label>
      <div class="row">
        <input id="senhaPainel" type="password" autocomplete="current-password">
        <button id="btnEntrar" type="button" class="btn-primary">Entrar</button>
        <a class="btn btn-gray" href="index.html">Voltar</a>
      </div>

      <div id="msgLogin" class="msg"></div>
    </div>

    <!-- PAINEL -->
    <div id="painelBox" style="display:none;">
      <div class="row">
        <button type="button" id="btnRecarregar" class="btn-green">Recarregar dados</button>
        <button type="button" id="btnPrev" class="btn-gray">Anterior</button>
        <button type="button" id="btnNext" class="btn-gray">Próxima</button>
        <a class="btn btn-gray" href="index.html">Voltar ao formulário</a>
      </div>

      <div id="statusUser"></div>
      <div id="tabelaWrapUser"></div>
    </div>
  </div>

<script>
  // === Apps Script ===
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwhWlvzkIy_VvF0-oU-p_VI4NTB_prCQNAgYFAfRktzEMKTY5LQhd9niw5z-1nkSuLd5A/exec";

  // === SENHA (mesma do Apps Script) ===
  const SENHA = "123";

  const KEY_OK = "bpa_gerencia_ok";

  // paginação
  let page = 1;
  let limit = 50;
  let totalPages = 1;

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function setNavDisabled(disabled) {
    document.getElementById("btnRecarregar").disabled = disabled;
    document.getElementById("btnPrev").disabled = disabled;
    document.getElementById("btnNext").disabled = disabled;
  }

  function updateNavButtons() {
    document.getElementById("btnPrev").disabled = (page <= 1);
    document.getElementById("btnNext").disabled = (page >= totalPages);
  }

  function jsonp(url, { timeoutMs = 20000 } = {}) {
    return new Promise((resolve, reject) => {
      const cbName = "cbUser_" + Date.now() + "_" + Math.floor(Math.random() * 1e6);
      const sep = url.includes("?") ? "&" : "?";
      const fullUrl = `${url}${sep}callback=${encodeURIComponent(cbName)}`;

      let timer = null;
      const s = document.createElement("script");

      function cleanup() {
        if (timer) clearTimeout(timer);
        timer = null;
        try { delete window[cbName]; } catch (_) { window[cbName] = undefined; }
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }

      window[cbName] = (data) => { cleanup(); resolve(data); };
      s.onerror = () => { cleanup(); reject(new Error("Erro ao carregar JSONP (script).")); };

      timer = setTimeout(() => {
        cleanup();
        reject(new Error("Timeout no JSONP."));
      }, timeoutMs);

      s.src = fullUrl;
      document.body.appendChild(s);
    });
  }

  function showPainel() {
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("painelBox").style.display = "block";
  }

  function showLogin() {
    document.getElementById("painelBox").style.display = "none";
    document.getElementById("loginBox").style.display = "block";
  }

  function filterEmptyColumns(head, rows) {
    // Mantém colunas que tenham algum valor no cabeçalho OU em alguma célula da página atual
    const colsToKeep = [];
    for (let j = 0; j < head.length; j++) {
      let hasValue = String(head[j] ?? "").trim() !== "";
      if (!hasValue) {
        for (let i = 0; i < rows.length; i++) {
          const v = rows[i][j];
          if (v !== null && v !== undefined && String(v).trim() !== "") {
            hasValue = true;
            break;
          }
        }
      }
      if (hasValue) colsToKeep.push(j);
    }

    const head2 = colsToKeep.map(j => head[j]);
    const rows2 = rows.map(r => colsToKeep.map(j => r[j]));
    return { head2, rows2, kept: colsToKeep.length, total: head.length };
  }

  async function carregarTabela() {
    const status = document.getElementById("statusUser");
    const wrap = document.getElementById("tabelaWrapUser");

    if (sessionStorage.getItem(KEY_OK) !== "1") {
      showLogin();
      return;
    }

    status.textContent = "Carregando...";
    wrap.innerHTML = "";
    setNavDisabled(true);

    try {
      const url = `${WEBAPP_URL}?senha=${encodeURIComponent(SENHA)}&page=${page}&limit=${limit}`;
      const data = await jsonp(url, { timeoutMs: 20000 });

      if (!data || !data.ok) {
        status.textContent = data?.erro || "Erro";
        return;
      }

      let head = data.head || [];
      let rows = data.rows || [];

      // atualiza paginação com o que veio do servidor
      page = Number(data.page || page);
      totalPages = Number(data.totalPages || 1);

      // NOVO: remove colunas totalmente vazias (sobras à direita)
      const filtered = filterEmptyColumns(head, rows);
      head = filtered.head2;
      rows = filtered.rows2;

      status.textContent =
        `Página ${data.page}/${data.totalPages} — Linhas nesta página: ${rows.length} — Total: ${data.totalRows} — Colunas exibidas: ${filtered.kept}/${filtered.total}`;

      wrap.innerHTML = `
        <table>
          <thead><tr>${head.map(h => `<th>${escapeHtml(h)}</th>`).join("")}</tr></thead>
          <tbody>
            ${rows.map(r => `<tr>${r.map(c => `<td>${escapeHtml(c)}</td>`).join("")}</tr>`).join("")}
          </tbody>
        </table>
      `;
    } catch (err) {
      status.textContent = "Falha: " + (err?.message || err);
      console.error(err);
    } finally {
      setNavDisabled(false);
      updateNavButtons();
    }
  }

  // Auto abre se já logou nesta aba
  if (sessionStorage.getItem(KEY_OK) === "1") {
    showPainel();
    carregarTabela();
  }

  document.getElementById("btnEntrar").addEventListener("click", () => {
    const inp = document.getElementById("senhaPainel");
    const msg = document.getElementById("msgLogin");
    msg.textContent = "";

    if ((inp.value || "").trim() !== SENHA) {
      msg.textContent = "Senha incorreta.";
      inp.focus();
      return;
    }

    sessionStorage.setItem(KEY_OK, "1");
    inp.value = "";
    showPainel();
    page = 1;
    carregarTabela();
  });

  document.getElementById("btnRecarregar").addEventListener("click", () => {
    carregarTabela();
  });

  document.getElementById("btnPrev").addEventListener("click", () => {
    if (page > 1) {
      page--;
      carregarTabela();
    }
  });

  document.getElementById("btnNext").addEventListener("click", () => {
    if (page < totalPages) {
      page++;
      carregarTabela();
    }
  });
</script>
</body>
</html>
