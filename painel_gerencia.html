<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel da Gerência</title>

<style>
body{
  font-family:Arial, sans-serif;
  background:#f4f6f8;
  padding:20px;
}
.card{
  max-width:1200px;
  margin:auto;
  background:#fff;
  padding:24px;
  border-radius:8px;
}
h2{
  border-left:5px solid #0077ff;
  padding-left:10px;
  margin-top:0;
}
.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  margin-top:12px;
}
button,a.btn{
  padding:10px 18px;
  border:none;
  border-radius:5px;
  cursor:pointer;
  font-size:14px;
  text-decoration:none;
}
.btn-primary{background:#0077ff;color:#fff;}
.btn-green{background:#28a745;color:#fff;}
.btn-gray{background:#e0e0e0;color:#111;}

#filters{
  display:flex;
  gap:10px;
  margin-top:12px;
}

#filters select,
#filters input{
  padding:8px;
  font-size:14px;
}

#statusUser{
  margin-top:10px;
  font-size:13px;
}

#tabelaWrapUser{
  margin-top:12px;
  overflow:auto;
  max-height:70vh;
  border:1px solid #e6e6e6;
  border-radius:6px;
}

table{
  border-collapse:collapse;
  width:100%;
}

th,td{
  border:1px solid #ddd;
  padding:8px;
  font-size:13px;
  white-space:nowrap;
}

th{
  background:#f0f7ff;
  position:sticky;
  top:0;
}
</style>
</head>

<body>
<div class="card">
  <h2>Painel da Gerência</h2>

  <div class="row">
    <button id="btnRecarregar" class="btn-green">Recarregar dados</button>
    <a href="index.html" class="btn btn-gray">Voltar ao formulário</a>
  </div>

  <!-- FILTROS -->
  <div id="filters">
    <select id="campoFiltro">
      <option value="Nome">Nome</option>
      <option value="Mes_Competencia">Mês</option>
      <option value="Ano_Competencia">Ano</option>
      <option value="Matricula">Matrícula</option>
      <option value="Email">E-mail</option>
      <option value="Setor_Nucleo">Setor</option>
    </select>

    <input id="filtroValor" placeholder="Digite para filtrar">
  </div>

  <div id="statusUser"></div>
  <div id="tabelaWrapUser"></div>
</div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwhWlvzkIy_VvF0-oU-p_VI4NTB_prCQNAgYFAfRktzEMKTY5LQhd9niw5z-1nkSuLd5A/exec";
const SENHA = "123";
const LIMIT = 50;

let HEAD = [];
let DATA = [];

/* JSONP */
function jsonp(url){
  return new Promise(res=>{
    const cb="cb"+Date.now()+Math.random().toString(36).slice(2);
    window[cb]=d=>{
      delete window[cb];
      s.remove();
      res(d);
    }
    const s=document.createElement("script");
    s.src=url+(url.includes("?")?"&":"?")+"callback="+cb;
    document.body.appendChild(s);
  });
}

/* RENDER */
function renderTabela(data){
  tabelaWrapUser.innerHTML = `
    <table>
      <thead>
        <tr>${data[0].map(h=>`<th>${h}</th>`).join("")}</tr>
      </thead>
      <tbody>
        ${data.slice(1).map(r=>`
          <tr>${r.map(c=>`<td>${c ?? ""}</td>`).join("")}</tr>
        `).join("")}
      </tbody>
    </table>
  `;
}

/* FILTRO POR COLUNA */
function aplicarFiltro(){
  const campo = campoFiltro.value;
  const termo = filtroValor.value.trim().toLowerCase();

  if(!termo){
    renderTabela(DATA);
    statusUser.textContent="";
    return;
  }

  const rowIndex = DATA.findIndex(r => r[0] === campo);
  if(rowIndex === -1) return;

  const colunasValidas = [];

  for(let c=1;c<DATA[rowIndex].length;c++){
    const valor = String(DATA[rowIndex][c] ?? "").toLowerCase();
    if(valor.includes(termo)) colunasValidas.push(c);
  }

  if(colunasValidas.length === 0){
    statusUser.textContent="Nenhum registro encontrado";
    tabelaWrapUser.innerHTML="";
    return;
  }

  const filtrado = DATA.map(r=>[
    r[0],
    ...colunasValidas.map(c=>r[c])
  ]);

  renderTabela(filtrado);
  statusUser.textContent = `Registros encontrados: ${colunasValidas.length}`;
}

/* CARREGAR */
async function carregarTabela(){
  statusUser.textContent="Carregando...";
  DATA = [];

  const first = await jsonp(`${WEBAPP_URL}?senha=${SENHA}&page=1&limit=${LIMIT}`);
  HEAD = first.head;

  DATA = [
    HEAD,
    ...first.rows
  ];

  for(let p=2;p<=first.totalPages;p++){
    const d = await jsonp(`${WEBAPP_URL}?senha=${SENHA}&page=${p}&limit=${LIMIT}`);
    DATA.push(...d.rows);
  }

  renderTabela(DATA);
  statusUser.textContent = `Registros carregados: ${DATA[0].length - 1}`;
}

btnRecarregar.onclick = carregarTabela;

let timer;
filtroValor.addEventListener("input",()=>{
  clearTimeout(timer);
  timer=setTimeout(aplicarFiltro,300);
});

carregarTabela();
</script>
</body>
</html>
